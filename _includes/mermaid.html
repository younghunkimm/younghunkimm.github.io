<!-- mermaid-js loader (UMD, global mermaid) -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
<script>
  (function () {
    var initTheme = 'default';
    var html = document.documentElement;
    if (
      (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') ||
      (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches)
    ) {
      initTheme = 'dark';
    }

    var basicList = document.getElementsByClassName('language-mermaid');
    Array.prototype.forEach.call(basicList, function (elem) {
      var svgCode = elem.textContent;
      var backup = elem.parentElement;
      if (backup) backup.classList.add('d-none');

      var mermaidEl = document.createElement('pre');
      mermaidEl.classList.add('mermaid');
      mermaidEl.textContent = svgCode;
      backup.after(mermaidEl);
    });

    mermaid.initialize({ startOnLoad: false, theme: initTheme });
    mermaid.run({ querySelector: '.mermaid' });

    function updateMermaid(event) {
      if (event.source === window && event.data && event.data.direction === ModeToggle.ID) {
        var mode = event.data.message;
        var expectedTheme = mode === ModeToggle.DARK_MODE ? 'dark' : 'default';

        var mermaidList = document.getElementsByClassName('mermaid');
        Array.prototype.forEach.call(mermaidList, function (el) {
          var svg = el.previousSibling && el.previousSibling.children ? el.previousSibling.children.item(0) : null;
          if (svg && svg.innerHTML) {
            el.innerHTML = svg.innerHTML;
          }
          el.removeAttribute('data-processed');
        });

        mermaid.initialize({ startOnLoad: false, theme: expectedTheme });
        mermaid.run({ querySelector: '.mermaid' });
      }
    }

    window.addEventListener('message', updateMermaid);
  })();
</script>
